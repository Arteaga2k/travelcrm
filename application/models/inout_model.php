<?phpinclude_once APPPATH."libraries/core/Docmodel.php";class Inout_model extends Docmodel{	public function __construct(){		parent::__construct();	}		public function get_ds(){		$this->db->select('SQL_CALC_FOUND_ROWS _documents.rid, 							DATE_FORMAT(_inout_headers.date_doc, \'%d.%m.%Y\') as date_doc,							(select _filials.rid 								FROM _emp_to_positions_rows 								JOIN _emp_to_positions_headers ON _emp_to_positions_rows._emp_to_positions_headers_rid=_emp_to_positions_headers.rid								JOIN _filials ON _emp_to_positions_rows._filials_rid=_filials.rid								WHERE _emp_to_positions_rows._employeers_rid = _employeers.rid AND _emp_to_positions_headers.date_doc < now() 								ORDER BY  _emp_to_positions_headers.date_doc ASC LIMIT 1							) as _filials_rid,							SUM(_finjournal.sum_value*_account_states.koef) as sum,													CONCAT(_employeers.l_name, \' \', SUBSTRING(_employeers.f_name FROM 1 FOR 1), \'.\') as emp_name,							DATE_FORMAT(_documents.modifyDT, \'%d.%m.%Y\') as modifyDT, 							_documents.descr as descr, _documents.archive', False);		$this->db->from('_documents');		$this->db->join('_inout_headers', '_inout_headers._documents_rid = _documents.rid');		$this->db->join('_finjournal', '_finjournal._documents_rid = _inout_headers._documents_rid');		$this->db->join('_account_states', '_account_states.rid = _finjournal._account_states_rid');		$this->db->join('_users', '_documents.owner_users_rid = _users.rid');		$this->db->join('_employeers', '_employeers.rid = _users._employeers_rid');		$this->db->group_by('_documents.rid');		$this->db->where(array('_documents.doc_type'=>$this->ci->get_typedoc()));		if($searchRule = element('like', $this->ci->get_session('searchrule'), null)) $this->db->like($searchRule);		if($searchRule = element('where', $this->ci->get_session('searchrule'), null)) $this->db->where($searchRule);		if($searchRule = element('having', $this->ci->get_session('searchrule'), null)) $this->db->having($searchRule);		if($sort = $this->ci->get_session('sort'))	$this->db->orderby($sort['c'], $sort['r']);		$this->db->limit($this->ci->config->item('crm_grid_limit'), element('p', $this->ci->a_uri_assoc, null));		$query = $this->db_get('_documents');		return $query->num_rows()?$query->result():array();	}		public function get_edit($rid){		$this->db->select('_documents.rid, 							DATE_FORMAT(_inout_headers.date_doc, \'%d.%m.%Y\') as date_doc,							DATE_FORMAT(_documents.modifyDT, \'%d.%m.%Y %H:%i\') as modifyDT, 							_documents.descr as descr, _documents.archive, _documents.owner_users_rid', False);		$this->db->from('_documents');		$this->db->join('_inout_headers', '_inout_headers._documents_rid = _documents.rid');		$this->db->where(array('_documents.rid'=>$rid));		$query = $this->db_get('_documents');		return $query->num_rows()?$query->row():False;	}	public function create_record(){		$ins_doc = array('doc_type'=>$this->ci->get_typedoc(), 							'descr'=>$this->ci->input->post('descr'),							'archive'=>$this->ci->input->post('archive'),							'owner_users_rid'=>get_curr_urid(),							'modifier_users_rid'=>get_curr_urid());		$this->db->set('createDT', 'now()', False);		$this->db->set('modifyDT', 'now()', False);		$this->db->trans_begin();		$this->db->insert('_documents', $ins_doc);		$doc_rid = $this->db->insert_id();		$ins_h = array('date_doc'=>date('Y-m-d', strtotime($this->ci->input->post('date_doc'))),								'_documents_rid'=>$doc_rid,								'owner_users_rid'=>get_curr_urid(),								'modifier_users_rid'=>get_curr_urid());		$this->db->set('createDT', 'now()', False);		$this->db->set('modifyDT', 'now()', False);		$this->db->insert('_inout_headers', $ins_h);		if ($this->db->trans_status() === FALSE){	   		$this->db->trans_rollback();    		return False;		}else{    		$this->db->trans_commit();    		return $doc_rid;		}			}		public function update_record(){		$update_doc = array('doc_type'=>$this->ci->get_typedoc(), 							'descr'=>$this->ci->input->post('descr'),							'archive'=>$this->ci->input->post('archive'),							'modifier_users_rid'=>get_curr_urid());		$this->db->set('modifyDT', 'now()', False);		$this->db->trans_begin();		$this->db->update('_documents', $update_doc, array('_documents.rid'=>$this->ci->input->post('rid')));		$update_h = array('date_doc'=>date('Y-m-d', strtotime($this->ci->input->post('date_doc'))),								'modifier_users_rid'=>get_curr_urid());		$this->db->set('modifyDT', 'now()', False);		$this->db->update('_inout_headers', $update_h, array('_inout_headers._documents_rid'=>$this->ci->input->post('rid')));		if ($this->db->trans_status() === FALSE){    		$this->db->trans_rollback();    		return False;		}else{    		$this->db->trans_commit();    		return $this->ci->input->post('rid');		}			}		public function move_record(){		$update_doc = array('owner_users_rid'=>get_urid_byemprid($this->ci->input->post('_employeers_rid')));		$this->db->set('modifyDT', 'now()', False);		$this->db->trans_begin();		$this->db->update('_documents', $update_doc, array('_documents.rid'=>$this->ci->input->post('rid')));		if ($this->db->trans_status() === FALSE){    		$this->db->trans_rollback();    		return False;		}else{    		$this->db->trans_commit();    		return $this->ci->input->post('rid');		}			}	}?>