<?phpinclude_once APPPATH."libraries/core/Reportmodel.php";class R_advactivity_model extends Reportmodel{	public function __construct(){		parent::__construct();	}		public function get_ds(){		$date_from = date('Y-m-d', strtotime($this->ci->input->post('date_report_from')));		$date_to = date('Y-m-d', strtotime($this->ci->input->post('date_report_to')));		$_filials_rid = $this->ci->input->post('_filials_rid');		$by_slice = $this->ci->input->post('by_slice');		$_advertisescompanies_rid = $this->ci->input->post('_advertisescompanies_rid');		# 1. Звонки		$this->db->select('count(_documents.rid) as quan,							_advertisestypes.rid as adv_type_rid,							_advertisestypes.type_name as adv_type_name,							_advertisessources.rid as adv_source_rid,							_advertisessources.source_name as adv_source_name, 							(select _filials.rid 								FROM _emp_to_positions_rows 								JOIN _emp_to_positions_headers ON _emp_to_positions_rows._emp_to_positions_headers_rid=_emp_to_positions_headers.rid								JOIN _filials ON _emp_to_positions_rows._filials_rid=_filials.rid								WHERE _emp_to_positions_rows._employeers_rid = _employeers.rid AND _emp_to_positions_headers.date_doc < now() 								ORDER BY  _emp_to_positions_headers.date_doc ASC LIMIT 1							) as _filials_rid', False);		$this->db->from('_documents');		$this->db->where(array('_documents.doc_type'=>'CALLS'));		$this->db->join('_calls_headers', '_calls_headers._documents_rid=_documents.rid');		$this->db->join('_calls_rows', '_calls_rows._calls_headers_rid=_calls_headers.rid');		$this->db->join('_advertisessources', '_advertisessources.rid=_calls_rows._advertisessources_rid');		$this->db->join('_advertisestypes', '_advertisessources._advertisestypes_rid=_advertisestypes.rid');		$this->db->join('_users', '_documents.owner_users_rid = _users.rid');		$this->db->join('_employeers', '_employeers.rid = _users._employeers_rid');		$this->db->where(array('_calls_headers.date_doc >='=>$date_from, '_calls_headers.date_doc <='=>$date_to));		if($_advertisescompanies_rid) $this->db->where("_advertisessources.rid in (select _advertisessources_rid from _advertises_headers where _advertises_headers._advertisescompanies_rid = {$_advertisescompanies_rid} )");		if($by_slice == 'type') $this->db->group_by('_advertisestypes.rid');		else $this->db->group_by('_advertisessources.source_name');		if($_filials_rid) $this->db->having(array('_filials_rid'=>$_filials_rid));		$query_calls = $this->db_get('_documents');		# ----------------				# 2. Звонки авиа		$this->db->select('count(_documents.rid) as quan,							_advertisestypes.rid as adv_type_rid,							_advertisestypes.type_name as adv_type_name,							_advertisessources.rid as adv_source_rid,							_advertisessources.source_name as adv_source_name, 							(select _filials.rid 								FROM _emp_to_positions_rows 								JOIN _emp_to_positions_headers ON _emp_to_positions_rows._emp_to_positions_headers_rid=_emp_to_positions_headers.rid								JOIN _filials ON _emp_to_positions_rows._filials_rid=_filials.rid								WHERE _emp_to_positions_rows._employeers_rid = _employeers.rid AND _emp_to_positions_headers.date_doc < now() 								ORDER BY  _emp_to_positions_headers.date_doc ASC LIMIT 1							) as _filials_rid', False);		$this->db->from('_documents');		$this->db->where(array('_documents.doc_type'=>'AIRCALLS'));		$this->db->join('_aircalls_headers', '_aircalls_headers._documents_rid=_documents.rid');		$this->db->join('_aircalls_rows', '_aircalls_rows._aircalls_headers_rid=_aircalls_headers.rid');		$this->db->join('_advertisessources', '_advertisessources.rid=_aircalls_rows._advertisessources_rid');		$this->db->join('_advertisestypes', '_advertisessources._advertisestypes_rid=_advertisestypes.rid');		$this->db->join('_users', '_documents.owner_users_rid = _users.rid');		$this->db->join('_employeers', '_employeers.rid = _users._employeers_rid');		$this->db->where(array('_aircalls_headers.date_doc >='=>$date_from, '_aircalls_headers.date_doc <='=>$date_to));		if($_advertisescompanies_rid) $this->db->where("_advertisessources.rid in (select _advertisessources_rid from _advertises_headers where _advertises_headers._advertisescompanies_rid = {$_advertisescompanies_rid} )");		if($by_slice == 'type') $this->db->group_by('_advertisestypes.rid');		else $this->db->group_by('_advertisessources.source_name');		if($_filials_rid) $this->db->having(array('_filials_rid'=>$_filials_rid));		$query_aircalls = $this->db_get('_documents');		# ----------------						# 3. Заявки		$this->db->select('count(_documents.rid) as quan,							_advertisestypes.rid as adv_type_rid,							_advertisestypes.type_name as adv_type_name,							_advertisessources.rid as adv_source_rid,							_advertisessources.source_name as adv_source_name, 							(select _filials.rid 								FROM _emp_to_positions_rows 								JOIN _emp_to_positions_headers ON _emp_to_positions_rows._emp_to_positions_headers_rid=_emp_to_positions_headers.rid								JOIN _filials ON _emp_to_positions_rows._filials_rid=_filials.rid								WHERE _emp_to_positions_rows._employeers_rid = _employeers.rid AND _emp_to_positions_headers.date_doc < now() 								ORDER BY  _emp_to_positions_headers.date_doc ASC LIMIT 1							) as _filials_rid', False);		$this->db->from('_documents');		$this->db->where(array('_documents.doc_type'=>'DEMANDS'));		$this->db->join('_demands_headers', '_demands_headers._documents_rid=_documents.rid');		$this->db->join('_advertisessources', '_advertisessources.rid=_demands_headers._advertisessources_rid');		$this->db->join('_advertisestypes', '_advertisessources._advertisestypes_rid=_advertisestypes.rid');		$this->db->join('_users', '_documents.owner_users_rid = _users.rid');		$this->db->join('_employeers', '_employeers.rid = _users._employeers_rid');		$this->db->where(array('_demands_headers.date_doc >='=>$date_from, '_demands_headers.date_doc <='=>$date_to));		if($_advertisescompanies_rid) $this->db->where("_advertisessources.rid in (select _advertisessources_rid from _advertises_headers where _advertises_headers._advertisescompanies_rid = {$_advertisescompanies_rid} )");		if($by_slice == 'type') $this->db->group_by('_advertisestypes.rid');		else $this->db->group_by('_advertisessources.source_name');		if($_filials_rid) $this->db->having(array('_filials_rid'=>$_filials_rid));		$query_demands = $this->db_get('_documents');		# ----------------		# 4. Заявки авиа		$this->db->select('count(_documents.rid) as quan,							_advertisestypes.rid as adv_type_rid,							_advertisestypes.type_name as adv_type_name,							_advertisessources.rid as adv_source_rid,							_advertisessources.source_name as adv_source_name, 							(select _filials.rid 								FROM _emp_to_positions_rows 								JOIN _emp_to_positions_headers ON _emp_to_positions_rows._emp_to_positions_headers_rid=_emp_to_positions_headers.rid								JOIN _filials ON _emp_to_positions_rows._filials_rid=_filials.rid								WHERE _emp_to_positions_rows._employeers_rid = _employeers.rid AND _emp_to_positions_headers.date_doc < now() 								ORDER BY  _emp_to_positions_headers.date_doc ASC LIMIT 1							) as _filials_rid', False);		$this->db->from('_documents');		$this->db->where(array('_documents.doc_type'=>'AIRSELL'));		$this->db->join('_airsell_headers', '_airsell_headers._documents_rid=_documents.rid');		$this->db->join('_advertisessources', '_advertisessources.rid=_airsell_headers._advertisessources_rid');		$this->db->join('_advertisestypes', '_advertisessources._advertisestypes_rid=_advertisestypes.rid');		$this->db->join('_users', '_documents.owner_users_rid = _users.rid');		$this->db->join('_employeers', '_employeers.rid = _users._employeers_rid');		$this->db->where(array('_airsell_headers.date_doc >='=>$date_from, '_airsell_headers.date_doc <='=>$date_to));		if($_advertisescompanies_rid) $this->db->where("_advertisessources.rid in (select _advertisessources_rid from _advertises_headers where _advertises_headers._advertisescompanies_rid = {$_advertisescompanies_rid} )");		if($by_slice == 'type') $this->db->group_by('_advertisestypes.rid');		else $this->db->group_by('_advertisessources.source_name');		if($_filials_rid) $this->db->having(array('_filials_rid'=>$_filials_rid));		$query_airsell = $this->db_get('_documents');		# ----------------		# 5. Формирование результата		$res = array();		$key_name = 'adv_type_rid'; 		if($by_slice !== 'type') $key_name = 'adv_source_rid';		if($query_calls->num_rows()){			foreach($query_calls->result() as $row) $res[$row->$key_name] = $row;		}		if($query_aircalls->num_rows()){			foreach($query_aircalls->result() as $row) {				if(isset($res[$row->$key_name])) $res[$row->$key_name]->quan += $row->quan;				else $res[$row->$key_name] = $row;			}		}		if($query_demands->num_rows()){			foreach($query_demands->result() as $row){				if(isset($res[$row->$key_name])) $res[$row->$key_name]->quan += $row->quan;				else $res[$row->$key_name] = $row;			}		}		if($query_airsell->num_rows()){			foreach($query_airsell->result() as $row){				if(isset($res[$row->$key_name])) $res[$row->$key_name]->quan += $row->quan;				else $res[$row->$key_name] = $row;			}		}		return $res?$res:array();	}
}
?>