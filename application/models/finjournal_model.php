<?phpinclude_once APPPATH."libraries/core/Crmmodel.php";class Finjournal_model extends Crmmodel{
	public function __construct(){		parent::__construct();	}		/**	 * Проверка существования документа	 */
	public function check_document($rid){		$query = $this->db->select('_documents.rid')->from('_documents')->where(array('rid'=>$rid))->get();		return $query->num_rows()?True:False; 		}		public function get_ds($rid){		$this->db->select('SQL_CALC_FOUND_ROWS _finjournal.rid as rid, 							(_finjournal.sum_value*_account_states.koef) as sum_value,							_currencies.currency_name as currency_name,							DATE_FORMAT(_finjournal.oper_date, \'%d.%m.%Y\') as oper_date,							_account_states.state_name as state_name,							_finjournal._documents_rid as doc_rid,							_finjournal.payment_type as payment_type,  							_finjournal.owner_users_rid,							_finjournal.archive,							DATE_FORMAT(_finjournal.modifyDT, \'%d.%m.%Y\') as modifyDT', False);		$this->db->from('_finjournal');		$this->db->join('_currencies', '_currencies.rid = _finjournal._currencies_rid');		$this->db->join('_account_states', '_account_states.rid = _finjournal._account_states_rid');		$this->db->where(array('_finjournal._documents_rid'=>$rid)); # ! выбираем только для конкретного документа		if($searchRule = $this->ci->get_session('searchrule')) $this->db->like($searchRule);		if($sort = $this->ci->get_session('sort'))	$this->db->orderby($sort['c'], $sort['r']);		$this->db->limit($this->ci->config->item('crm_grid_limit'), element('p', $this->ci->a_uri_assoc, null));		$query = $this->db_get('_finjournal');		return $query->num_rows()?$query->result():array();	}
		public function get_edit($rid){		$this->db->select('_finjournal.rid as rid, 							_finjournal._documents_rid as _documents_rid,							_finjournal.sum_value as sum_value,														_finjournal.credit_c_type as credit_c_type,							_finjournal.debet_c_type as debet_c_type,														(CASE _finjournal.credit_c_type 								WHEN \'CLIENT\' THEN _finjournal.credit_clients_rid								WHEN \'FILIAL\' THEN _finjournal.credit_filials_rid								WHEN \'EMPLOYEER\' THEN _finjournal.credit_employeers_rid								WHEN \'TOUROPERATOR\' THEN _finjournal.credit_touroperators_rid 								WHEN \'CONTRAHENT\' THEN _finjournal.credit_contrahents_rid							END) as creditor_rid, 							(CASE _finjournal.debet_c_type 								WHEN \'CLIENT\' THEN _finjournal.debet_clients_rid								WHEN \'FILIAL\' THEN _finjournal.debet_filials_rid								WHEN \'EMPLOYEER\' THEN _finjournal.debet_employeers_rid								WHEN \'TOUROPERATOR\' THEN _finjournal.debet_touroperators_rid								WHEN \'CONTRAHENT\' THEN _finjournal.debet_contrahents_rid  							END) as debetor_rid, 														_finjournal._currencies_rid as _currencies_rid,							DATE_FORMAT(_finjournal.oper_date, \'%d.%m.%Y\') as oper_date,							_finjournal._account_states_rid as _account_states_rid,							_finjournal.payment_type as payment_type,  							_finjournal.owner_users_rid,							_finjournal.archive,							_finjournal.descr,							DATE_FORMAT(_finjournal.modifyDT, \'%d.%m.%Y %H:%i\') as modifyDT', False);		$this->db->from('_finjournal');		$this->db->where(array('_finjournal.rid'=>$rid));		$query = $this->db_get('_finjournal');		return $query->num_rows()?$query->row():False;	}
	
	public function create_record(){		$ins_arr = array('_documents_rid'=>$this->ci->input->post('_documents_rid'),							'_currencies_rid'=>$this->ci->input->post('_currencies_rid'),							'_account_states_rid'=>$this->ci->input->post('_account_states_rid'),							'payment_type'=>$this->ci->input->post('payment_type'),							'oper_date'=>date('Y-m-d', strtotime($this->ci->input->post('oper_date'))),							'sum_value'=>floatval($this->ci->input->post('sum_value')),							'credit_c_type'=>$this->ci->input->post('c_type_credit'),							'debet_c_type'=>$this->ci->input->post('c_type_debet'),									'credit_c_type'=>$this->ci->input->post('c_type_credit'),							'debet_c_type'=>$this->ci->input->post('c_type_debet'),							'credit_clients_rid'=>($this->ci->input->post('c_type_credit')=='CLIENT')?$this->ci->input->post('creditor_rid'):null,							'debet_clients_rid'=>($this->ci->input->post('c_type_debet')=='CLIENT')?$this->ci->input->post('debetor_rid'):null,							'credit_filials_rid'=>($this->ci->input->post('c_type_credit')=='FILIAL')?$this->ci->input->post('creditor_rid'):null,							'debet_filials_rid'=>($this->ci->input->post('c_type_debet')=='FILIAL')?$this->ci->input->post('debetor_rid'):null,							'credit_employeers_rid'=>($this->ci->input->post('c_type_credit')=='EMPLOYEER')?$this->ci->input->post('creditor_rid'):null,							'debet_employeers_rid'=>($this->ci->input->post('c_type_debet')=='EMPLOYEER')?$this->ci->input->post('debetor_rid'):null,							'credit_touroperators_rid'=>($this->ci->input->post('c_type_credit')=='TOUROPERATOR')?$this->ci->input->post('creditor_rid'):null,							'debet_touroperators_rid'=>($this->ci->input->post('c_type_debet')=='TOUROPERATOR')?$this->ci->input->post('debetor_rid'):null,							'credit_contrahents_rid'=>($this->ci->input->post('c_type_credit')=='CONTRAHENT')?$this->ci->input->post('creditor_rid'):null,							'debet_contrahents_rid'=>($this->ci->input->post('c_type_debet')=='CONTRAHENT')?$this->ci->input->post('debetor_rid'):null,									'descr'=>$this->ci->input->post('descr'),							'archive'=>$this->ci->input->post('archive'),							'owner_users_rid'=>get_curr_urid(),							'modifier_users_rid'=>get_curr_urid());		$this->db->set('createDT', 'now()', False);		$this->db->set('modifyDT', 'now()', False);		$this->db->trans_begin();		$this->db->insert('_finjournal', $ins_arr);		$insRid = $this->db->insert_id();		if ($this->db->trans_status() === FALSE){    		$this->db->trans_rollback();    		return False;		}else{    		$this->db->trans_commit();    		return $insRid;		}			}
	
	public function update_record(){		$update_arr = array('_documents_rid'=>$this->ci->input->post('_documents_rid'),							'_currencies_rid'=>$this->ci->input->post('_currencies_rid'),							'_account_states_rid'=>$this->ci->input->post('_account_states_rid'),							'payment_type'=>$this->ci->input->post('payment_type'),							'oper_date'=>date('Y-m-d', strtotime($this->ci->input->post('oper_date'))),							'sum_value'=>floatval($this->ci->input->post('sum_value')),							'credit_c_type'=>$this->ci->input->post('c_type_credit'),							'debet_c_type'=>$this->ci->input->post('c_type_debet'),							'credit_clients_rid'=>($this->ci->input->post('c_type_credit')=='CLIENT')?$this->ci->input->post('creditor_rid'):null,							'debet_clients_rid'=>($this->ci->input->post('c_type_debet')=='CLIENT')?$this->ci->input->post('debetor_rid'):null,							'credit_filials_rid'=>($this->ci->input->post('c_type_credit')=='FILIAL')?$this->ci->input->post('creditor_rid'):null,							'debet_filials_rid'=>($this->ci->input->post('c_type_debet')=='FILIAL')?$this->ci->input->post('debetor_rid'):null,							'credit_employeers_rid'=>($this->ci->input->post('c_type_credit')=='EMPLOYEER')?$this->ci->input->post('creditor_rid'):null,							'debet_employeers_rid'=>($this->ci->input->post('c_type_debet')=='EMPLOYEER')?$this->ci->input->post('debetor_rid'):null,							'credit_touroperators_rid'=>($this->ci->input->post('c_type_credit')=='TOUROPERATOR')?$this->ci->input->post('creditor_rid'):null,							'debet_touroperators_rid'=>($this->ci->input->post('c_type_debet')=='TOUROPERATOR')?$this->ci->input->post('debetor_rid'):null,							'credit_contrahents_rid'=>($this->ci->input->post('c_type_credit')=='CONTRAHENT')?$this->ci->input->post('creditor_rid'):null,							'debet_contrahents_rid'=>($this->ci->input->post('c_type_debet')=='CONTRAHENT')?$this->ci->input->post('debetor_rid'):null,									'descr'=>$this->ci->input->post('descr'),							'archive'=>$this->ci->input->post('archive'),							'modifier_users_rid'=>get_curr_urid());		$this->db->set('modifyDT', 'now()', False);		$this->db->trans_begin();		$this->db->update('_finjournal', $update_arr, array('rid'=>$this->ci->input->post('rid')));		if ($this->db->trans_status() === FALSE){    		$this->db->trans_rollback();    		return False;		}else{    		$this->db->trans_commit();    		return True;		}			}
		public function remove_items(){		$this->db->trans_begin();		foreach($this->ci->input->post('row') as $rid){			$this->db->delete('_finjournal', array('rid'=>$rid));			}		if ($this->db->trans_status() === FALSE){    		$this->db->trans_rollback();    		return False;		}else{    		$this->db->trans_commit();    		return True;		}			}
	
	public function move_record(){		$update_doc = array('owner_users_rid'=>get_urid_byemprid($this->ci->input->post('_employeers_rid')));		$this->db->set('modifyDT', 'now()', False);		$this->db->trans_begin();		$this->db->update('_finjournal', $update_doc, array('_finjournal.rid'=>$this->ci->input->post('rid')));		if ($this->db->trans_status() === FALSE){    		$this->db->trans_rollback();    		return False;		}else{    		$this->db->trans_commit();    		return $this->ci->input->post('rid');		}			}		public function get_doc_in($doc_rid){		$this->db->select('sum(_finjournal.sum_value*_account_states.koef) as sum_value');		$this->db->from('_finjournal');		$this->db->join('_account_states', '_account_states.rid = _finjournal._account_states_rid');		$this->db->where(array('_finjournal._documents_rid'=>$doc_rid, '_account_states.koef > '=>0));		$this->db->group_by('_finjournal._documents_rid');		$query = $this->db_get('_finjournal');		return $query->num_rows()?$query->row()->sum_value:0;	}		public function get_doc_out($doc_rid){		$this->db->select('sum(_finjournal.sum_value*_account_states.koef) as sum_value');		$this->db->from('_finjournal');		$this->db->join('_account_states', '_account_states.rid = _finjournal._account_states_rid');		$this->db->where(array('_finjournal._documents_rid'=>$doc_rid, '_account_states.koef < '=>0));		$this->db->group_by('_finjournal._documents_rid');		$query = $this->db_get('_finjournal');		return $query->num_rows()?$query->row()->sum_value:0;	}		}?>