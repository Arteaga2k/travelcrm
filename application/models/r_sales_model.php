<?phpinclude_once APPPATH."libraries/core/Reportmodel.php";class R_sales_model extends Reportmodel{	public function __construct(){		parent::__construct();	}		public function get_ds(){		$date_from = date('Y-m-d', strtotime($this->ci->input->post('date_report_from')));		$date_to = date('Y-m-d', strtotime($this->ci->input->post('date_report_to')));		$_filials_rid = $this->ci->input->post('_filials_rid');		$this->db->select('_documents.rid as doc_rid, 							(select count(_demands_rows.rid) from _demands_rows where _demands_rows._demands_headers_rid = _demands_headers.rid) as tourists_quan,							_tours.sum as sum,							_tours.order_sum as order_sum,							_countries.country_name,							_touroperators.stouroperator_name,							(select CONCAT(_clients.l_name, \' \', SUBSTRING(_clients.f_name FROM 1 FOR 1), \'.\', SUBSTRING(_clients.s_name FROM 1 FOR 1), \'.\') 								from _demands_rows								join _clients on _demands_rows._clients_rid = _clients.rid								where _demands_rows.demander = 1 and _demands_rows._demands_headers_rid = _demands_headers.rid							) as demander,							sum(if(_account_states.koef > 0, _finjournal.sum_value*_account_states.koef, 0)) as oborot,							sum(_finjournal.sum_value*_account_states.koef) as doxod,							(select _filials.rid 								FROM _emp_to_positions_rows 								JOIN _emp_to_positions_headers ON _emp_to_positions_rows._emp_to_positions_headers_rid=_emp_to_positions_headers.rid								JOIN _filials ON _emp_to_positions_rows._filials_rid=_filials.rid								WHERE _emp_to_positions_rows._employeers_rid = _employeers.rid AND _emp_to_positions_headers.date_doc < now() 								ORDER BY  _emp_to_positions_headers.date_doc DESC LIMIT 1							) as _filials_rid,							(select _filials.name  								FROM _emp_to_positions_rows 								JOIN _emp_to_positions_headers ON _emp_to_positions_rows._emp_to_positions_headers_rid=_emp_to_positions_headers.rid								JOIN _filials ON _emp_to_positions_rows._filials_rid=_filials.rid								WHERE _emp_to_positions_rows._employeers_rid = _employeers.rid AND _emp_to_positions_headers.date_doc < now() 								ORDER BY  _emp_to_positions_headers.date_doc DESC LIMIT 1							) as filial_name,							CONCAT(_employeers.l_name, \' \', SUBSTRING(_employeers.f_name FROM 1 FOR 1), \'.\') as emp_name', False);		$this->db->from('_documents');		$this->db->join('_finjournal', "_finjournal._documents_rid = _documents.rid and _finjournal.oper_date between '{$date_from}' and '{$date_to}'", 'LEFT');		$this->db->join('_demands_headers', '_demands_headers._documents_rid = _documents.rid');		$this->db->join('_tours', '_tours.rid = _demands_headers._tours_rid');		$this->db->join('_touroperators', '_touroperators.rid = _tours._touroperators_rid');		$this->db->join('_countries', '_countries.rid = _tours._countries_rid');		$this->db->join('_account_states', '_finjournal._account_states_rid = _account_states.rid');		$this->db->join('_users', '_documents.owner_users_rid = _users.rid');		$this->db->join('_employeers', '_employeers.rid = _users._employeers_rid');		$this->db->where(array('_documents.doc_type'=>'DEMANDS',								'_demands_headers.date_doc >='=>$date_from, '_demands_headers.date_doc <='=>$date_to,								'_tours.anulated !='=>1));		if($_filials_rid) $this->db->having(array('_filials_rid'=>$_filials_rid));		$this->db->order_by('filial_name, emp_name');		$this->db->group_by('_documents.rid');		$query = $this->db_get('_documents');		return $query->num_rows()?$query->result():array();	}	
}
?>